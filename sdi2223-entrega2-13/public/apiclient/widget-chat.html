<div id="widget-chat">
  <h1>Conversación</h1>
  <table className="table table-hover">
    <thead>
    <tr>
      <th>Autor</th>
      <th>Fecha y hora del envío</th>
      <th>Mensaje</th>
      <th>Leído</th>
    </tr>
    </thead>
    <tbody id="messagesTableBody"></tbody>
  </table>
  <div class="form-group">
    <label class="control-label col-sm-2" for="msg-add">Mensaje:</label>
    <input type="text" class="form-control" name="msg-add"
           placeholder="Mensaje" id="msg-add" />
    <div class="col-sm-offset-2 col-sm-10">
      <button type="button" class="btn btn-primary" id="msg-send"
              onclick="widgetSendMsg()">Enviar</button>
    </div>
  </div>
</div>
<script>
  window.history.pushState("", "", "/apiclient/client.html?w=chat");
  function loadMessages() {
    $.ajax({
      url: URLbase + "/offers/messages/" + selectedOfferId,
      type: "GET",
      data: {},
      dataType: 'json',
      headers: {"token": token},
      success: function (response) {
        messages = response.messages;
        updateMessagesTable(messages);
      },
      error: function (error) {
        $("#main-container").load("widget-login.html");
      }
    });
  }
  function updateMessagesTable(messages) {
    $("#messagesTableBody").empty(); // Vaciar la tabla
    for (i = 0; i < messages.length; i++) {
      const timestamp = messages[i].date;
      const date = new Date(timestamp);
      const dateHour = date.toLocaleString();
      $("#messagesTableBody").append(
              "<tr>" +
              "<td>" + messages[i].author + "</td>" +
              "<td>" + dateHour + "</td>" +
              "<td>" + messages[i].text + "</td>" +
              "<td>" + messages[i].read + "</td>" +
              "</tr>");
    }
  }

  function startAutoUpdate() {
    setInterval(function() {
      loadMessages();
    }, 1000);
  }

  startAutoUpdate();

  function widgetSendMsg(){
    $.ajax({
      url: URLbase + "/offers/messages",
      type: "POST",
      data: {
        buyer: "user01@email.com",
        seller: "user02@email.com",
        offer: selectedOfferId,
        text: $("#msg-add").val(),
        date: Date.now(),
        price: false
      },
      dataType: 'json',
      headers: {"token": token},
      success: function (response) {
        console.log("Mensaje enviado: ");
      },
      error: function (error) {
        $("#main-container").load("widget-login.html");
      }
    });
  }

</script>